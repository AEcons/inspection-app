<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>รายงานสรุป</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>สรุปสถานะของโครงการ</h2>
  <label>เลือกโครงการ: 
    <select id="projectSelect" onchange="loadSummary()"></select>
  </label>
  <div id="summary"></div>

  <script>
    const records = JSON.parse(localStorage.getItem('aeRecords') || '[]');
    const projectSelect = document.getElementById('projectSelect');
    const projects = [...new Set(records.map(r => r.project))];

    projectSelect.innerHTML = '<option value="all">ทุกโครงการ</option>' +
      projects.map(p => `<option value="${p}">${p}</option>`).join('');

    function loadSummary() {
      const selected = projectSelect.value;
      const filtered = selected === 'all' ? records : records.filter(r => r.project === selected);
      const total = filtered.length;

      const statusCount = {
        'ระหว่างแก้ไข': 0,
        'QC Pass': 0,
        'ลูกบ้านรับมอบ': 0
      };

      const itemCount = {};

      filtered.forEach(r => {
        if (r.status in statusCount) statusCount[r.status]++;
        if (!itemCount[r.description]) itemCount[r.description] = 0;
        itemCount[r.description]++;
      });

      const remain = total - Object.values(statusCount).reduce((a,b) => a + b, 0);
      const top3 = Object.entries(itemCount).sort((a,b) => b[1] - a[1]).slice(0,3);

      document.getElementById('summary').innerHTML = `
        <p><strong>จำนวนรายการทั้งหมด:</strong> ${total}</p>
        <p><strong>อยู่ระหว่างแก้ไข:</strong> ${statusCount['ระหว่างแก้ไข']}</p>
        <p><strong>QC Pass:</strong> ${statusCount['QC Pass']}</p>
        <p><strong>ลูกบ้านรับมอบ:</strong> ${statusCount['ลูกบ้านรับมอบ']}</p>
        <p><strong>คงเหลือรอดำเนินการ:</strong> ${remain}</p>
        <p><strong>รายการยอดนิยม 3 อันดับ:</strong></p>
        <ol>
          ${top3.map(([desc,count]) => `<li>${desc} (${count} รายการ)</li>`).join('')}
        </ol>
      `;
    }

    loadSummary();
  </script>
</body>
</html>
