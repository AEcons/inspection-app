<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>р╕лр╕Щр╣Йр╕▓р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Зр╕▓р╕Щ</h1>
  <form id="recordForm">
    <label>р╕Кр╕╖р╣Ир╕нр╣Вр╕Др╕гр╕Зр╕Бр╕▓р╕г: <input id="project" required></label>
    <label>р╣Ар╕ер╕Вр╣Бр╕Ыр╕ер╕З: <input id="plot" required></label>
    <label>р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Ар╕гр╕┤р╣Ир╕б: <input type="date" id="startDate" required></label>
    <label>р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Ар╕кр╕гр╣Зр╕И: <input type="date" id="endDate"></label>
    <label>р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Зр╕▓р╕Щ: <textarea id="description" required></textarea></label>

    <label>ЁЯУ╖ р╕гр╕╣р╕Ыр╕Бр╣Ир╕нр╕Щр╕Чр╕│ 1: <input type="file" id="before1" accept="image/*" capture="environment"></label>
    <label>ЁЯУ╖ р╕гр╕╣р╕Ыр╕Бр╣Ир╕нр╕Щр╕Чр╕│ 2: <input type="file" id="before2" accept="image/*" capture="environment"></label>
    <label>ЁЯУ╖ р╕гр╕╣р╕Ыр╕лр╕ер╕▒р╕Зр╕Чр╕│ 1: <input type="file" id="after1" accept="image/*" capture="environment"></label>
    <label>ЁЯУ╖ р╕гр╕╣р╕Ыр╕лр╕ер╕▒р╕Зр╕Чр╕│ 2: <input type="file" id="after2" accept="image/*" capture="environment"></label>

    <label>р╕кр╕Цр╕▓р╕Щр╕░:
      <select id="status">
        <option value="р╕нр╕вр╕╣р╣Ир╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╣Бр╕Бр╣Йр╣Др╕В">р╕нр╕вр╕╣р╣Ир╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╣Бр╕Бр╣Йр╣Др╕В</option>
        <option value="QC р╕Ьр╣Ир╕▓р╕Щ">QC р╕Ьр╣Ир╕▓р╕Щ</option>
        <option value="р╕ер╕╣р╕Бр╕Ър╣Йр╕▓р╕Щр╕гр╕▒р╕Ър╕бр╕нр╕Ъ">р╕ер╕╣р╕Бр╕Ър╣Йр╕▓р╕Щр╕гр╕▒р╕Ър╕бр╕нр╕Ъ</option>
      </select>
    </label>
    <button type="submit">р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</button>
  </form>

  <button onclick="loadPrevious()">ЁЯУВ р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Фр╕┤р╕б</button>
  <button onclick="location.href='index.html'">ЁЯФЩ р╕Бр╕ер╕▒р╕Ър╣Ар╕бр╕Щр╕╣р╕лр╕ер╕▒р╕Б</button>

  <script>
    const form = document.getElementById('recordForm');
    const user = localStorage.getItem('aeUser') || '-';

    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    form.onsubmit = async function(e) {
      e.preventDefault();
      const before1 = form.before1.files[0] ? await toBase64(form.before1.files[0]) : '';
      const before2 = form.before2.files[0] ? await toBase64(form.before2.files[0]) : '';
      const after1 = form.after1.files[0] ? await toBase64(form.after1.files[0]) : '';
      const after2 = form.after2.files[0] ? await toBase64(form.after2.files[0]) : '';

      const record = {
        project: form.project.value.trim(),
        plot: form.plot.value.trim(),
        startDate: form.startDate.value,
        endDate: form.endDate.value,
        description: form.description.value.trim(),
        beforeImage: [before1, before2].filter(x => x).join('|'),
        afterImage: [after1, after2].filter(x => x).join('|'),
        status: form.status.value,
        user
      };

      const response = await fetch("https://script.google.com/macros/s/AKfycbz6TxFLY4L6kX15soOUBd-jRMY5cBB80jZtEDhJkkBq4TRLW6EhdmvxOPizJSo5w3jzHg/exec", {
        method: "POST",
        body: JSON.stringify([record]),
        headers: { "Content-Type": "application/json" }
      });

      const text = await response.text();
      alert(text);
      form.reset();
    };

    async function loadPrevious() {
      const url = "https://script.google.com/macros/s/AKfycbz6TxFLY4L6kX15soOUBd-jRMY5cBB80jZtEDhJkkBq4TRLW6EhdmvxOPizJSo5w3jzHg/exec";
      const res = await fetch(url);
      const records = await res.json();
      const proj = prompt("р╕Бр╕гр╕нр╕Бр╕Кр╕╖р╣Ир╕нр╣Вр╕Др╕гр╕Зр╕Бр╕▓р╕г:");
      const plot = prompt("р╕Бр╕гр╕нр╕Бр╣Ар╕ер╕Вр╣Бр╕Ыр╕ер╕З:");
      const found = records.reverse().find(r => r.project === proj && r.plot === plot);
      if (!found) return alert("р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Фр╕┤р╕б");

      form.project.value = found.project;
      form.plot.value = found.plot;
      form.startDate.value = found.startDate;
      form.endDate.value = found.endDate;
      form.description.value = found.description;
      form.status.value = found.status;

      alert("р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Фр╕┤р╕бр╕кр╕│р╣Ар╕гр╣Зр╕И р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕Юр╕┤р╣Ир╕бр╕гр╕╣р╕Ыр╕лр╕ер╕▒р╕Зр╕Чр╕│р╕лр╕гр╕╖р╕нр╕Ыр╕гр╕▒р╕Ър╕кр╕Цр╕▓р╕Щр╕░ р╣Бр╕ер╣Йр╕зр╕Бр╕Ф 'р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б'");
    }
  </script>
</body>
</html>
