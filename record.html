<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h1>
  <form id="recordForm">
    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: <input id="project" required></label>
    <label>‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏•‡∏á: <input id="plot" required></label>
    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°: <input type="date" id="startDate" required></label>
    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à: <input type="date" id="endDate"></label>
    <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô: <textarea id="description" required></textarea></label>

    <label>üì∑ ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥ 1:
      <div style="display:flex; align-items:center; gap:10px;">
        <input type="file" id="before1" accept="image/*" capture="environment" />
        <img id="previewBefore1" src="" style="width:100px; border:1px solid #ccc;" />
      </div>
    </label>
    <label>üì∑ ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥ 2:
      <div style="display:flex; align-items:center; gap:10px;">
        <input type="file" id="before2" accept="image/*" />
        <img id="previewBefore2" src="" style="width:100px; border:1px solid #ccc;" />
      </div>
    </label>
    <label>üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥ 1:
      <div style="display:flex; align-items:center; gap:10px;">
        <input type="file" id="after1" accept="image/*" capture="environment" />
        <img id="previewAfter1" src="" style="width:100px; border:1px solid #ccc;" />
      </div>
    </label>
    <label>üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥ 2:
      <div style="display:flex; align-items:center; gap:10px;">
        <input type="file" id="after2" accept="image/*" />
        <img id="previewAfter2" src="" style="width:100px; border:1px solid #ccc;" />
      </div>
    </label>

    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
      <select id="status">
        <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</option>
        <option value="QC ‡∏ú‡πà‡∏≤‡∏ô">QC ‡∏ú‡πà‡∏≤‡∏ô</option>
        <option value="‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö">‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö</option>
      </select>
    </label>
    <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </form>

  <button type="button" onclick="editPrevious()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <button type="button" onclick="location.href='index.html'">üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>

  <script>
    const form = document.getElementById('recordForm');
    const user = localStorage.getItem('aeUser') || '-';
    let editingIndex = -1;

    function previewFile(input, imgId) {
      if (!input.files[0]) return;
      const reader = new FileReader();
      reader.onload = () => {
        document.getElementById(imgId).src = reader.result;
      };
      reader.readAsDataURL(input.files[0]);
    }

    ["before1", "before2", "after1", "after2"].forEach(id => {
      form[id].addEventListener("change", e => previewFile(e.target, "preview" + id.charAt(0).toUpperCase() + id.slice(1)));
    });

    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    form.onsubmit = async function(e) {
      e.preventDefault();
      const before1 = form.before1.files[0] ? await toBase64(form.before1.files[0]) : document.getElementById("previewBefore1").src;
      const before2 = form.before2.files[0] ? await toBase64(form.before2.files[0]) : document.getElementById("previewBefore2").src;
      const after1 = form.after1.files[0] ? await toBase64(form.after1.files[0]) : document.getElementById("previewAfter1").src;
      const after2 = form.after2.files[0] ? await toBase64(form.after2.files[0]) : document.getElementById("previewAfter2").src;

      const record = {
        project: form.project.value.trim(),
        plot: form.plot.value.trim(),
        startDate: form.startDate.value,
        endDate: form.endDate.value,
        description: form.description.value.trim(),
        beforeImage: [before1, before2].filter(Boolean).join('|'),
        afterImage: [after1, after2].filter(Boolean).join('|'),
        status: form.status.value,
        user,
        timestamp: new Date().toISOString()
      };

      let records = JSON.parse(localStorage.getItem("aeRecords") || "[]");
      if (editingIndex >= 0) {
        records[editingIndex] = record;
        alert("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      } else {
        records.push(record);
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      }
      localStorage.setItem("aeRecords", JSON.stringify(records));
      editingIndex = -1;
      form.reset();
      ["previewBefore1", "previewBefore2", "previewAfter1", "previewAfter2"].forEach(id => document.getElementById(id).src = "");
    };

    function editPrevious() {
      const proj = form.project.value.trim();
      const plot = form.plot.value.trim();
      if (!proj || !plot) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏•‡∏á");

      const records = JSON.parse(localStorage.getItem("aeRecords") || "[]");
      const index = records.findIndex(r => r.project === proj && r.plot === plot);
      if (index === -1) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°");

      const r = records[index];
      form.project.value = r.project;
      form.plot.value = r.plot;
      form.startDate.value = r.startDate;
      form.endDate.value = r.endDate;
      form.description.value = r.description;
      form.status.value = r.status;

      const [b1, b2] = r.beforeImage.split('|');
      const [a1, a2] = r.afterImage.split('|');
      console.log("‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", r.beforeImage, r.afterImage);
      const [b1, b2] = (r.beforeImage || '').split('|');
      const [a1, a2] = (r.afterImage || '').split('|');
      document.getElementById("previewBefore1").src = b1 ? b1 : '';
      document.getElementById("previewBefore2").src = b2 ? b2 : '';
      document.getElementById("previewAfter1").src = a1 ? a1 : '';
      document.getElementById("previewAfter2").src = a2 ? a2 : '';
      editingIndex = index;

      alert("üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    }
  </script>
</body>
</html>