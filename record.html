<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h1>
  <form id="recordForm">
    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: <input id="project" required></label>
    <label>‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏•‡∏á: <input id="plot" required></label>
    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°: <input type="date" id="startDate" required></label>
    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à: <input type="date" id="endDate"></label>
    <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô: <textarea id="description" required></textarea></label>

    
    <label style="display:block">
      üì∑ ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥ 1:
      <input type="file" id="before1 capture="environment"></label>
    
    <label style="display:block">
      üì∑ ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥ 2:
      <input type="file" id="before2></label>
    
    <label style="display:block">
      üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥ 1:
      <input type="file" id="after1 capture="environment"></label>
    
    <label style="display:block">
      üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥ 2:
      <input type="file" id="after2></label>

    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
      <select id="status">
        <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</option>
        <option value="QC ‡∏ú‡πà‡∏≤‡∏ô">QC ‡∏ú‡πà‡∏≤‡∏ô</option>
        <option value="‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö">‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö</option>
      </select>
    </label>
    
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <img id="previewBefore1" src="" style="max-width:100px;">
      <img id="previewBefore2" src="" style="max-width:100px;">
      <img id="previewAfter1" src="" style="max-width:100px;">
      <img id="previewAfter2" src="" style="max-width:100px;">
    </div>

    <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </form>

  <button type="button" onclick="editPrevious()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <button type="button" onclick="location.href='index.html'">üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>

  <script>
    const form = document.getElementById('recordForm');
    const user = localStorage.getItem('aeUser') || '-';
    let editingIndex = -1;

    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function saveRecord(e) {
      e.preventDefault();
      const before1 = form.before1.files[0] ? await toBase64(form.before1.files[0]) : '';
      const before2 = form.before2.files[0] ? await toBase64(form.before2.files[0]) : '';
      const after1 = form.after1.files[0] ? await toBase64(form.after1.files[0]) : '';
      const after2 = form.after2.files[0] ? await toBase64(form.after2.files[0]) : '';

      const record = {
        project: form.project.value.trim(),
        plot: form.plot.value.trim(),
        startDate: form.startDate.value,
        endDate: form.endDate.value,
        description: form.description.value.trim(),
        beforeImage: [before1, before2].filter(x => x).join('|'),
        afterImage: [after1, after2].filter(x => x).join('|'),
        status: form.status.value,
        user,
        timestamp: new Date().toISOString()
      };

      let localData = JSON.parse(localStorage.getItem("aeRecords") || "[]");
      if (editingIndex >= 0) {
        localData[editingIndex] = record;
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      } else {
        localData.push(record);
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      }
      localStorage.setItem("aeRecords", JSON.stringify(localData));
      form.reset();
      editingIndex = -1;
    }

    function editPrevious() {
      const proj = form.project.value.trim();
      const plot = form.plot.value.trim();
      if (!proj || !plot) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô");

      let localData = JSON.parse(localStorage.getItem("aeRecords") || "[]");
      const index = localData.findIndex(r => r.project === proj && r.plot === plot);
      if (index === -1) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°");

      const found = localData[index];
      document.getElementById('previewBefore1').src = '';
document.getElementById('previewBefore2').src = '';
document.getElementById('previewAfter1').src = '';
document.getElementById('previewAfter2').src = '';
form.project.value = found.project;
      form.plot.value = found.plot;
      form.startDate.value = found.startDate;
      form.endDate.value = found.endDate;
      form.description.value = found.description;
      form.status.value = found.status;
      
      const beforeImages = found.beforeImage.split('|');
      const afterImages = found.afterImage.split('|');
      document.getElementById('previewBefore1').src = beforeImages[0] || '';
      document.getElementById('previewBefore2').src = beforeImages[1] || '';
      document.getElementById('previewAfter1').src = afterImages[0] || '';
      document.getElementById('previewAfter2').src = afterImages[1] || '';

document.getElementById('previewBefore2').src = found.beforeImage.split('|')[1] || '';
document.getElementById('previewAfter1').src = found.afterImage.split('|')[0] || '';
document.getElementById('previewAfter2').src = found.afterImage.split('|')[1] || '';
editingIndex = index;

      alert("üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏Å‡∏î '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    }

    
    
    function previewFile(file, imgId) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const img = document.getElementById(imgId);
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    // ‡πÅ‡∏™‡∏î‡∏á preview ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û
    form.before1.onchange = e => previewFile(e.target.files[0], 'previewBefore1');
    form.before2.onchange = e => previewFile(e.target.files[0], 'previewBefore2');
    form.after1.onchange = e => previewFile(e.target.files[0], 'previewAfter1');
    form.after2.onchange = e => previewFile(e.target.files[0], 'previewAfter2');

    function previewFile(file, imgId) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => document.getElementById(imgId).src = reader.result;
      reader.readAsDataURL(file);
    }

    form.addEventListener("submit", saveRecord);
  </script>
</body>
</html>