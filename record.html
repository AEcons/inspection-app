<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>р╕лр╕Щр╣Йр╕▓р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Зр╕▓р╕Щ</h1>
  <form id="recordForm">
    <label>р╕Кр╕╖р╣Ир╕нр╣Вр╕Др╕гр╕Зр╕Бр╕▓р╕г: <input id="project" required></label>
    <label>р╣Ар╕ер╕Вр╣Бр╕Ыр╕ер╕З: <input id="plot" required></label>
    <label>р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Ар╕гр╕┤р╣Ир╕б: <input type="date" id="startDate" required></label>
    <label>р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Ар╕кр╕гр╣Зр╕И: <input type="date" id="endDate"></label>
    <label>р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Зр╕▓р╕Щ: <textarea id="description" required></textarea></label>

    <label>ЁЯУ╖ р╕гр╕╣р╕Ыр╕Бр╣Ир╕нр╕Щр╕Чр╕│ 1:
      <input type="file" id="before1" accept="image/*" capture="environment">
    </label>
    <label>ЁЯУ╖ р╕гр╕╣р╕Ыр╕Бр╣Ир╕нр╕Щр╕Чр╕│ 2:
      <input type="file" id="before2" accept="image/*">
    </label>
    <label>ЁЯУ╖ р╕гр╕╣р╕Ыр╕лр╕ер╕▒р╕Зр╕Чр╕│ 1:
      <input type="file" id="after1" accept="image/*" capture="environment">
    </label>
    <label>ЁЯУ╖ р╕гр╕╣р╕Ыр╕лр╕ер╕▒р╕Зр╕Чр╕│ 2:
      <input type="file" id="after2" accept="image/*">
    </label>

    <label>р╕кр╕Цр╕▓р╕Щр╕░:
      <select id="status">
        <option value="р╕нр╕вр╕╣р╣Ир╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╣Бр╕Бр╣Йр╣Др╕В">р╕нр╕вр╕╣р╣Ир╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╣Бр╕Бр╣Йр╣Др╕В</option>
        <option value="QC р╕Ьр╣Ир╕▓р╕Щ">QC р╕Ьр╣Ир╕▓р╕Щ</option>
        <option value="р╕ер╕╣р╕Бр╕Ър╣Йр╕▓р╕Щр╕гр╕▒р╕Ър╕бр╕нр╕Ъ">р╕ер╕╣р╕Бр╕Ър╣Йр╕▓р╕Щр╕гр╕▒р╕Ър╕бр╕нр╕Ъ</option>
      </select>
    </label>
    <button type="submit">р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</button>
  </form>

  <button type="button" onclick="loadPrevious()">ЁЯУВ р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Фр╕┤р╕б</button>
  <button type="button" onclick="location.href='index.html'">ЁЯФЩ р╕Бр╕ер╕▒р╕Ър╣Ар╕бр╕Щр╕╣р╕лр╕ер╕▒р╕Б</button>

  <script>
    const form = document.getElementById('recordForm');
    const user = localStorage.getItem('aeUser') || '-';

    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    form.onsubmit = async function(e) {
      e.preventDefault();
      const before1 = form.before1.files[0] ? await toBase64(form.before1.files[0]) : '';
      const before2 = form.before2.files[0] ? await toBase64(form.before2.files[0]) : '';
      const after1 = form.after1.files[0] ? await toBase64(form.after1.files[0]) : '';
      const after2 = form.after2.files[0] ? await toBase64(form.after2.files[0]) : '';

      const record = {
        project: form.project.value.trim(),
        plot: form.plot.value.trim(),
        startDate: form.startDate.value,
        endDate: form.endDate.value,
        description: form.description.value.trim(),
        beforeImage: [before1, before2].filter(x => x).join('|'),
        afterImage: [after1, after2].filter(x => x).join('|'),
        status: form.status.value,
        user,
        timestamp: new Date().toISOString()
      };

      let localData = JSON.parse(localStorage.getItem("aeRecords") || "[]");
      localData.push(record);
      localStorage.setItem("aeRecords", JSON.stringify(localData));
      alert("тЬЕ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕ер╕Зр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з");
      form.reset();
    };

    function loadPrevious() {
      const proj = form.project.value.trim();
      const plot = form.plot.value.trim();
      if (!proj || !plot) return alert("р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕░р╕Ър╕╕р╕Кр╕╖р╣Ир╕нр╣Вр╕Др╕гр╕Зр╕Бр╕▓р╕гр╣Бр╕ер╕░р╣Ар╕ер╕Вр╣Бр╕Ыр╕ер╕Зр╕Бр╣Ир╕нр╕Щ");

      let localData = JSON.parse(localStorage.getItem("aeRecords") || "[]");
      const found = localData.reverse().find(r => r.project === proj && r.plot === plot);
      if (!found) return alert("тЭМ р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Фр╕┤р╕б");

      form.project.value = found.project;
      form.plot.value = found.plot;
      form.startDate.value = found.startDate;
      form.endDate.value = found.endDate;
      form.description.value = found.description;
      form.status.value = found.status;

      alert("ЁЯУВ р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Фр╕┤р╕бр╕кр╕│р╣Ар╕гр╣Зр╕И р╕Бр╕гр╕╕р╕Ур╕▓р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕гр╕╣р╕Ыр╕лр╕гр╕╖р╕нр╕кр╕Цр╕▓р╕Щр╕░ р╣Бр╕ер╣Йр╕зр╕Бр╕Ф 'р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б'");
    }
  </script>
</body>
</html>