<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>รายงาน</title>
  <style>
    body { font-family: sans-serif; padding: 10px; max-width: 800px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .green { background-color: #d4edda; }
    .yellow { background-color: #fff3cd; }
    select, button { width: 100%; margin: 5px 0; padding: 10px; box-sizing: border-box; }
    .print-options { display: flex; gap: 10px; margin-top: 20px; }
  </style>
</head>
<body>

  <h2>รายงาน</h2>
  <select id="projectSelect"><option value="">เลือกโครงการ</option></select>
  <select id="plotSelect"><option value="">เลือกเลขแปลง</option></select>

  <table>
    <thead><tr><th>เลขแปลง</th><th>จำนวนรายการ</th><th>แสดงรายละเอียด</th></tr></thead>
    <tbody id="reportBody"></tbody>
  </table>

  <!-- ลบปุ่มพิมพ์ -->
    
    
  </div>
  <button onclick="location.href='index.html'">กลับเมนูหลัก</button>

  

  <script>
    const data = JSON.parse(localStorage.getItem('inspectionData') || '[]');
    const projects = [...new Set(data.map(item => item.project))];
    const projectSelect = document.getElementById('projectSelect');
    const plotSelect = document.getElementById('plotSelect');
    const reportBody = document.getElementById('reportBody');

    projects.forEach(proj => {
      const opt = document.createElement('option');
      opt.value = proj;
      opt.textContent = proj;
      projectSelect.appendChild(opt);
    });

    projectSelect.addEventListener('change', () => {
      const selectedProject = projectSelect.value;
      const plots = [...new Set(data.filter(d => d.project === selectedProject).map(d => d.plot))];
      plotSelect.innerHTML = '<option value="">เลือกเลขแปลง</option>';
      plots.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        plotSelect.appendChild(opt);
      });
      
      if (selectedProject) {
        renderTable(selectedProject);
      } else {
        reportBody.innerHTML = '';
      }
    
    });

    function renderTable(project) {
      const filtered = data.filter(d => d.project === project);
      const grouped = {};
      filtered.forEach(d => {
        if (!grouped[d.plot]) grouped[d.plot] = [];
        grouped[d.plot].push(d);
      });
      reportBody.innerHTML = '';
      for (const plot in grouped) {
        const status = grouped[plot][grouped[plot].length - 1].status;
        const colorClass = status === 'QC pass' ? 'yellow' : status === 'ลูกค้ารับมอบ' ? 'green' : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="${colorClass}">${plot}</td><td>${grouped[plot].length}</td>
          <td><button onclick="showDetail('${project}','${plot}')">ดู</button></td>`;
        reportBody.appendChild(tr);
      }
    }

    function showDetail(project, plot) {
      sessionStorage.setItem('project', project);
      sessionStorage.setItem('plot', plot);
      location.href = 'detail.html';
    }

    // พิมพ์ถูกลบออก {
      const project = projectSelect.value;
      const plot = plotSelect.value;
      if (!project || !plot) return alert("กรุณาเลือกโครงการและเลขแปลงก่อนพิมพ์");

      const entries = data.filter(d => d.project === project && d.plot === plot);
      printData(entries, `โครงการ: ${project} | แปลง: ${plot}`);
    }

    function printAll() {
      const project = projectSelect.value;
      if (!project) return alert("กรุณาเลือกโครงการก่อนพิมพ์");

      const entries = data.filter(d => d.project === project);
      const grouped = {};
      entries.forEach(d => {
        if (!grouped[d.plot]) grouped[d.plot] = [];
        grouped[d.plot].push(d);
      });

      let html = '';
      for (const plot in grouped) {
        html += `<h3>แปลง ${plot}</h3>`;
        grouped[plot].forEach((d, i) => {
          html += `<p><strong>รายการ ${i + 1}</strong><br>วันที่เริ่ม: ${d.start}<br>วันที่เสร็จ: ${d.end}<br>สถานะ: ${d.status}</p>
          <p>รูปก่อน:<br><img src="${d.beforeImg}" width="200"/></p>
          <p>รูปหลัง:<br><img src="${d.afterImg}" width="200"/></p><hr>`;
        });
      }

      printData(null, html, true);
    }

    function printData(entries, header = '', isRawHTML = false) {
      const frame = document.getElementById('printFrame');
      const doc = frame.contentWindow.document;
      doc.open();
      doc.write(`<html><head><title>พิมพ์</title></head><body>`);
      doc.write(`<h2>${header}</h2>`);
      if (isRawHTML) {
        doc.write(header);
      } else {
        entries.forEach((d, i) => {
          doc.write(`<p><strong>รายการ ${i + 1}</strong><br>วันที่เริ่ม: ${d.start}<br>วันที่เสร็จ: ${d.end}<br>สถานะ: ${d.status}</p>
          <p>รูปก่อน:<br><img src="${d.beforeImg}" width="200"/></p>
          <p>รูปหลัง:<br><img src="${d.afterImg}" width="200"/></p><hr>`);
        });
      }
      doc.write(`</body></html>`);
      doc.close();
      frame.contentWindow.focus();
      frame.contentWindow.print();
    }
  </script>
</body>
</html>

detail.html
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>แสดงรายละเอียด</title>
  <style>
    body { font-family: sans-serif; padding: 10px; max-width: 700px; margin: auto; }
    img { max-width: 100%; margin: 10px 0; }
    .footer { display: flex; justify-content: space-between; margin-top: 50px; }
    @media print {
      button { display: none; }
    }
  </style>
</head>
<body>
  <h2>แสดงรายละเอียด</h2>
  <div id="details"></div>
  <div class="footer">
    <div>ผู้ควบคุมงาน</div>
    <div>ผู้อนุมัติ</div>
  </div>
  <button onclick="window.print()">พิมพ์หน้านี้</button>
  <script>
    const project = sessionStorage.getItem('project');
    const plot = sessionStorage.getItem('plot');
    const data = JSON.parse(localStorage.getItem('inspectionData') || '[]');
    const filtered = data.filter(d => d.project === project && d.plot === plot);
    const detail = filtered[filtered.length - 1];
    document.getElementById('details').innerHTML = `
      <p>โครงการ: ${detail.project}</p>
      <p>เลขแปลง: ${detail.plot}</p>
      <p>วันที่เริ่ม: ${detail.start}</p>
      <p>วันที่เสร็จ: ${detail.end}</p>
      <p>สถานะบ้าน: ${detail.status}</p>
      <p>รูปก่อนแก้ไข:</p><img src="${detail.beforeImg}" />
      <p>รูปหลังแก้ไข:</p><img src="${detail.afterImg}" />
    `;
  </script>
</body>
</html>

